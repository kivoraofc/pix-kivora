<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Gerador PIX - PUSHIN PAY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#2b2b2b;
      --blue:#ff1f2d; /* primary (used for chips) */
      --blue-hover:#ff4747;
      --blue-press:#c70f17;
      --white:#ffffff;
      --muted:#ff9aa0; /* lighter muted for status */
      --red:#ff3b3b;
      --red-hover:#ff6b6b;
      --red-press:#c72020;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
      color:var(--white);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .wrap{
      width:100%;
      max-width:960px;
      padding:40px 20px 56px;
      text-align:center;
      position:relative;
    }
    .title{
      font-size:clamp(28px,6vw,64px);
      font-weight:900;
      margin:0;
    }
    .subtitle{
      font-size:clamp(16px,3vw,36px);
      font-weight:700;
      color:var(--red);
      margin:8px 0 28px 0;
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 22px;
      margin: 34px auto 10px;
      max-width: 740px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:90px;
      height:72px;
      border-radius:20px;
      background:var(--blue);
      color:#fff;
      font-weight:900;
      font-size:32px;
      border:none;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(255, 31, 45, 0.35);
      transition:transform .05s ease, background .15s ease, box-shadow .15s ease;
      user-select:none;
    }
    .chip:hover{
      background:var(--blue-hover);
      box-shadow:0 10px 24px rgba(255, 71, 71, 0.45);
    }
    .chip:active{
      transform:translateY(1px);
      background:var(--blue-press);
    }

    .qr{
      width:220px;height:220px;border-radius:14px;
      margin:28px auto 10px; display:none; box-shadow:0 6px 20px rgba(0,0,0,.25);
    }
    .mono{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:.95rem; line-height:1.25rem;
      background:#00000022; color:#e9eefc;
      border-radius:10px; padding:10px; margin:12px auto 0;
      max-width:720px; word-break:break-all; text-align:left; display:none;
    }
    .status{
      margin-top:12px; font-size:1.05rem; color:var(--muted); font-weight:700;
    }
    .copy-btn{
      margin-top:10px;
      background:var(--blue);
      border:none;
      border-radius:10px;
      color:#fff;
      padding:10px 16px;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(255, 60, 60, 0.28);
      display:none;
      transition:background .15s ease, box-shadow .15s ease;
    }
    .copy-btn:hover{
      background:var(--blue-hover);
      box-shadow:0 8px 18px rgba(255, 47, 47, 0.36);
    }
    .copy-btn:active{background:var(--blue-press)}

    /* Botão fechar aba */
    #close-btn{
      position:absolute;
      top:10px;
      right:18px;
      background:var(--red);
      color:#fff;
      font-size:0.9rem;
      font-weight:600;
      border:none;
      border-radius:8px;
      padding:8px 14px;
      cursor:pointer;
      z-index:10;
      transition:background .2s, transform .1s;
    }
    #close-btn:hover{background:var(--red-hover);}
    #close-btn:active{
      background:var(--red-press);
      transform:scale(0.96);
    }

    .hidden{display:none}
    .sr-only{position:absolute!important;border:0;padding:0;width:1px;height:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
    .custom-row{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:18px}
    .custom-row input[type="number"]{width:200px;padding:10px 12px;border-radius:10px;border:1px solid #333;background:#00000022;color:var(--white);font-weight:700}
    .generate-btn{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(255,31,45,0.25)}
    .generate-btn:hover{background:var(--blue-hover)}
  </style>
</head>
<body>
  <div class="wrap">
    <button id="close-btn">FECHAR ABA</button>
    <h1 class="title">GERADOR PIX</h1>
    <div class="subtitle">PUSHIN PAY - KIVORA</div>

    <div class="grid" id="amountGrid">
      <button class="chip" data-amount="10">10</button>
      <button class="chip" data-amount="15">15</button>
      <button class="chip" data-amount="20">20</button>
      <button class="chip" data-amount="25">25</button>
      <button class="chip" data-amount="30">30</button>
      <button class="chip" data-amount="35">35</button>
      <button class="chip" data-amount="40">40</button>
      <button class="chip" data-amount="45">45</button>
      <button class="chip" data-amount="50">50</button>
    </div>

    <img id="qr" class="qr" alt="QR Code">
    <div id="emv" class="mono"></div>
    <div id="status" class="status"></div>
    <button id="copyBtn" class="copy-btn">COPIAR CHAVE</button>

    <div id="customRow" class="custom-row">
      <label for="amount" class="sr-only">Valor em reais (R$)</label>
      <input id="amount" name="amount" type="number" step="0.01" min="1" max="150" placeholder="R$ 1,00 - 150,00" inputmode="decimal" aria-label="Valor em reais">
      <button id="generateBtn" type="button" class="generate-btn">GERAR PIX</button>
    </div>
  </div>

  <script>
    document.getElementById('close-btn').onclick = () => {
      window.close();
      setTimeout(() => {
        if (!window.closed) alert('Por segurança do navegador, feche esta aba manualmente.');
      }, 300);
    };

    const $ = s => document.querySelector(s);
    let currentId = null, lastCheck = 0;

    document.getElementById('amountGrid').addEventListener('click', e => {
      const b = e.target.closest('.chip');
      if (!b) return;
      const v = Number(b.dataset.amount).toFixed(2);
      $("#amount").value = v;
      createCharge(v);
    });

    async function createCharge(amount){
      setUI({loading:true});
      try{
        // envia { amountBRL } ; compatível com backend Python
        const r = await fetch("/api/pix",{
          method:"POST",
          headers:{"content-type":"application/json"},
          body:JSON.stringify({ amountBRL: Number(amount) })
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.detail?.message || j.error || "falha ao gerar cobrança");

        // id em chaves variadas
        currentId = j.id || j.transaction_id || j.uuid || j.data?.id || null;

        // emv/copy-paste em chaves variadas
        const emv = j.copyPaste || j.emv || j.emvPayload || j.payload || j.data?.copyPaste || "";
        // imagem do QR em várias chaves; força data URI se vier base64 cru
        const qrImg = j.pngBase64 || j.qr_code || j.qrcode || j.qrCodeImage || j.qr || j.qrImage || j.image || j.data?.pngBase64 || null;

        if (emv) {
          $("#emv").textContent = emv;
          $("#emv").style.display = "block";
          $("#copyBtn").style.display = "inline-block";
          $("#copyBtn").onclick = () => {
            navigator.clipboard.writeText(emv).then(()=>{
              $("#copyBtn").textContent = "COPIADO!";
              setTimeout(()=>$("#copyBtn").textContent="COPIAR CHAVE",2000);
            });
          };
        } else {
          $("#emv").style.display = "none";
          $("#copyBtn").style.display = "none";
        }

        if (qrImg) {
          $("#qr").src = qrImg.startsWith("data:") ? qrImg : `data:image/png;base64,${qrImg}`;
          $("#qr").style.display = "block";
        } else {
          $("#qr").style.display = "none";
        }

        $("#status").textContent = "Status: " + (j.status || "created");
      }catch(err){
        $("#status").textContent = "Erro: " + err.message;
        $("#qr").style.display = "none";
        $("#emv").style.display = "none";
        $("#copyBtn").style.display = "none";
      }finally{
        setUI({loading:false});
      }
    }

    function setUI({loading}){
      if (loading) $("#status").textContent = "Gerando cobrança PIX...";
    }

    document.addEventListener("keydown", async e => {
      if (e.key !== "s" || !currentId) return;
      const now = Date.now();
      if (now - lastCheck < 60000) return alert("1 consulta por minuto");
      lastCheck = now;
      const r = await fetch("/api/status?id=" + encodeURIComponent(currentId));
      const j = await r.json();
      $("#status").textContent = "Status: " + (j?.status || "desconhecido");
    });

    // Gera PIX a partir do valor digitado pelo usuário (entre R$1 e R$200)
    document.getElementById('generateBtn').addEventListener('click', () => {
      const raw = document.getElementById('amount').value;
      const normalized = String(raw).replace(',', '.');
      const val = Number(normalized);
      if (!raw || isNaN(val)) {
        $("#status").textContent = "Erro: valor inválido";
        return;
      }
      if (val < 1 || val > 200) {
        $("#status").textContent = "Erro: informe valor entre R$1 e R$200";
        return;
      }
      // chama a função existente para criar a cobrança
      createCharge(val.toFixed(2));
    });
  </script>
</body>
</html>
